---
layout: page
title: Detecting common threats (WIP)
permalink: /Detecting-common-threats
---



This lab is the very first one I completed while following along in a challenge ([MyDFIR's 30 day SOC Analyst challenge](https://youtube.com/playlist?list=PLG6KGSNK4PuBb0OjyDIdACZnb8AoNBeq6&si=j-P3c9dueGik3gG-)) to begin experimenting with a bare bones SOC environment that includes the the victim and attack machines, log forwarding and analysis using Fleet and the ELK stack, and Mythic to establish a C2 server, and osTicket for monitoring alerts. This was done entirely in the cloud using VULTR's resources. The lab is fairly easy to set up and understand, and the majority of attacks today target cloud environments, so it's a good opportunity for any beginner like me to security to quickly cultivate practical experience. 

I began this lab around October 2024 and finished most of it but suck at documentation, so this is a late write-up.

In this lab, I will be investigating brute force SSH and RDP attempts, as well as C2 activity to the victim machines I've set up.

## Setting up the lab


I [received a free $300 in credits with VULTR](https://www.vultr.com/?ref=9632889-9J) (MyDFIR's referral link) to create my environment in the cloud. 

My setup was as follows:
- Windows 2022 Server with RDP exposed
- Fleet server (Ubuntu 22.02) for log forwarding
- Elasticsearch/Kibana instance (Ubuntu 22.04) for analysis and alerting
- Mythic C2 server (Ubuntu 22.04) to emulate attack
- osTicket server (Windows Standard 2022) to track and manage incidents

<img src="{{ site.baseurl }}/assets/VULTR (CP).png" width="700">


### 1. Creation of VPC and Ubuntu machine
I made my Virtual Private Cloud labeled "MYDFIR-SOC-Challenge" with an IP range of `172.30.0.1-254` before creating the Ubuntu machine. ("MYDFIR-ELK") Both need to be in the same region/datacenter so they can see each other. I also generated an SSH keypair to use to connect to my machine.

<img src="{{ site.baseurl }}/assets/Untitled design(1).png" width="700">
# Change image

<img src="{{ site.baseurl }}/assets/ssh-auth.png" width="800">


#### 1a. Installation of Elastic and Kibana
I then began to install Elastic and Kibana on the machine using the following commands:
~~~
# Fetching installation packages
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-9.0.1-amd64.deb https://artifacts.elastic.co/downloads/kibana/kibana-9.0.1-amd64.deb
~~~
<img src="{{ site.baseurl }}/assets/install-elastic-package.png" width="500">

~~~
# Installing both instances
dpkg -i https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-9.0.1-amd64.deb https://artifacts.elastic.co/downloads/kibana/kibana-9.0.1-amd64.deb
~~~

I wrote down the superuser password that is generated for Elastic under "Security Autoconfiguration Information", as it is needed to login later. 
Then, in both Elastic and Kibana's configuration files, I made a couple changes so the instance was accessible to the SOC Analyst laptop. I changed `#network.host` to the public IP address of the Ubuntu machine, and uncommented `#http.port: 9200` so Elastic could communicate with Kibana. 
I also created and modified a firewall in Digital Ocean via "Networking" to allow inbound TCP traffic from my public IP, as well as allowed port `5601` on the machine itself to ensure the web UI was accessible. 

<img src="{{ site.baseurl }}/assets/firewall-allow.png" width="700">
# Change the second image

One more thing that is needed before accessing the console is an enrollment token for Kibana, which I got by navigating to `usr/share/elasticsearch/bin` and executing:
~~~
elasticsearch-create-enrollment-token --scope kibana
~~~ 

I entered the enrollment token, the superuser password generated, and after another return to the terminal, the 6-digit verification code requested which can be generated by navigating to `usr/share/kibana/bin` and excuting `kibana-verification-code`.

<img src="{{ site.baseurl }}/assets/Untitled design.png" width="900">

### 3. Installation of Windows 2022 Server


 


